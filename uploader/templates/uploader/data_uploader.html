{# uploader/templates/uploader/data_uploader.html #}

{% extends "uploader/base.html" %}
{% block title %}Data Uploader{% endblock %}

{% block content %}
<hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

<h2 class="govuk-heading-l">Upload a CSV file</h2>

<form method="post" enctype="multipart/form-data" action=".">
  {% csrf_token %}

  <div class="govuk-form-group" id="uploader-group">
    <label class="govuk-label" for="file-upload">
      Choose a .csv file to upload
    </label>

    <input class="govuk-file-upload"
           id="file-upload"
           name="file-upload"
           type="file"
           accept=".csv">

    <div id="dropzone"
         class="govuk-panel"
         role="button"
         tabindex="0"
         aria-describedby="dropzone-hint dropzone-status">
      <div class="govuk-panel__body">
        Drag & drop a .csv here<br>
        <span class="govuk-hint" id="dropzone-hint">â€¦or click/press Enter to browse</span>
        <div class="govuk-visually-hidden" aria-live="polite" id="dropzone-status"></div>
      </div>
    </div>

    <p class="govuk-hint" id="csv-hint">Accepted format: .csv (comma-separated values)</p>
    <p class="govuk-error-message" id="csv-error" style="display:none;">Error: Please upload a .csv file.</p>
  </div>

  {% include "uploader/data_preview.html" %}
  {% include "uploader/metadata.html" %}

  <div class="govuk-button-group govuk-!-margin-top-4">
    <button class="govuk-button" data-module="govuk-button" type="submit">
      Upload file and Save Metadata
    </button>
  </div>
</form>

<style>
  #dropzone {
    cursor: pointer;
    border: 2px dashed #b1b4b6;
    background: #f3f2f1;
    padding: 24px;
    text-align: center;
    border-radius: 8px;
    margin-top: 12px;
  }
  #dropzone.is-dragover { background: #e7f0ff; border-color: #1d70b8; }
  .has-error #dropzone, .has-error .govuk-file-upload { border-color: #d4351c !important; }
</style>

<script>
(function () {
  const dropzone   = document.getElementById('dropzone');
  const input      = document.getElementById('file-upload');
  const status     = document.getElementById('dropzone-status');
  const errorMsg   = document.getElementById('csv-error');
  const group      = document.getElementById('uploader-group');

  function clearError() {
    errorMsg.style.display = 'none';
    group.classList.remove('has-error');
  }
  function showError(msg) {
    errorMsg.textContent = msg || 'Error: Please upload a .csv file.';
    errorMsg.style.display = '';
    group.classList.add('has-error');
    status.textContent = '';
  }
  function isCsv(file) {
    if (!file) return false;
    const nameOk = file.name.toLowerCase().endsWith('.csv');
    const typeOk = ['text/csv','application/vnd.ms-excel'].includes((file.type||'').toLowerCase());
    return nameOk || typeOk;
  }

  async function setFile(file) {
    if (!isCsv(file)) {
      input.value = '';
      showError('Error: Please upload a .csv file.');
      return;
    }
    clearError();

    const dt = new DataTransfer();
    dt.items.add(file);
    input.files = dt.files;
    status.textContent = `Selected: ${file.name}`;

    try {
      if (window.CsvPreview && typeof CsvPreview.fromFile === 'function') {
        await CsvPreview.fromFile(file);
      }
    } catch (e) {
      console.error(e);
    }
  }

  dropzone.addEventListener('click', () => input.click());
  dropzone.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); }
  });
  input.addEventListener('change', () => {
    const file = input.files && input.files[0];
    if (!file) return;
    setFile(file);
  });

  ['dragenter','dragover','dragleave','drop'].forEach(evt => {
    dropzone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); });
  });
  ['dragenter','dragover'].forEach(evt => {
    dropzone.addEventListener(evt, () => dropzone.classList.add('is-dragover'));
  });
  ['dragleave','drop'].forEach(evt => {
    dropzone.addEventListener(evt, () => dropzone.classList.remove('is-dragover'));
  });
  dropzone.addEventListener('drop', (e) => {
    const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file) return;
    setFile(file);
  });
})();
</script>
{% endblock %}