{# uploader/templates/uploader/data_preview.html #}

<div class="govuk-form-group" id="preview-group" style="display:none;">
  <label class="govuk-label">Preview (first 10 rows)</label>
  <div id="preview-container" class="govuk-!-margin-top-2" aria-live="polite"></div>
</div>

<style>
  #preview-container {
    border: 1px solid #b1b4b6;
    border-radius: 6px;
    padding: 8px;
    max-height: 260px;
    overflow: auto;
    background: #fff;
  }
  #preview-container table { width: max-content; border-collapse: collapse; }
  #preview-container th, #preview-container td {
    border-bottom: 1px solid #eee;
    padding: 6px 8px;
    vertical-align: top;
    text-align: left;
    font-family: monospace;
    font-size: 14px;
    white-space: nowrap;
    word-break: break-word;
  }
  #preview-container thead th { white-space: nowrap; position: sticky; top: 0; background: #f3f2f1; }
</style>

<script>
window.CsvPreview = (function () {
  const previewGroup = document.getElementById('preview-group');
  const preview = document.getElementById('preview-container');
  const PLACEHOLDER_MSG = 'No file selected. Choose or drop a CSV file to preview the first 10 rows.';
  let lastState = null;

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  function showPlaceholder() {
    if (!preview || !previewGroup) return;
    preview.innerHTML = `<p class="govuk-hint">${escapeHtml(PLACEHOLDER_MSG)}</p>`;
    previewGroup.style.display = '';
    lastState = null;
  }

  function detectDelimiter(sample) {
    const candidates = [',',';','\t','|'];
    let best = ',', bestCount = -1;
    for (const d of candidates) {
      const count = (sample.match(new RegExp(`\\${d}`, 'g')) || []).length;
      if (count > bestCount) { best = d; bestCount = count; }
    }
    return best;
  }

  function parseCSV(text, delimiter) {
    const rows = [];
    let row = [], cur = '', inQuotes = false;
    for (let i = 0; i < text.length; i++) {
      const ch = text[i];
      if (inQuotes) {
        if (ch === '"') {
          if (text[i+1] === '"') { cur += '"'; i++; }
          else { inQuotes = false; }
        } else { cur += ch; }
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === delimiter) { row.push(cur); cur = ''; }
        else if (ch === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; }
        else if (ch === '\r') { /* ignore */ }
        else { cur += ch; }
      }
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }
    if (rows.length && rows[rows.length-1].length === 1 && rows[rows.length-1][0] === '') rows.pop();
    return rows;
  }

  function render(rows) {
    if (!preview || !previewGroup || !rows || !rows.length) {
      showPlaceholder();
      return;
    }

    const maxRows = Math.min(11, rows.length);
    const cols = Math.max(...rows.slice(0, maxRows).map(r => r.length));
    const norm = rows.slice(0, maxRows).map(r => {
      const copy = r.slice();
      while (copy.length < cols) copy.push('');
      return copy;
    });

    const header = norm[0];
    const bodyRows = norm.slice(1);

    let html = '<table><thead><tr>' + header.map(h => `<th>${escapeHtml(h)}</th>`).join('') + '</tr></thead><tbody>';
    bodyRows.forEach(r => {
      html += '<tr>' + r.map(c => `<td>${escapeHtml(c)}</td>`).join('') + '</tr>';
    });
    html += '</tbody></table>';

    preview.innerHTML = html;
    previewGroup.style.display = '';
    return { header, bodyRows };
  }

  async function fromFile(file) {
    const CHUNK = 256 * 1024; // 256KB
    const blob = file.slice(0, CHUNK);
    const text = await blob.text();
    const firstLine = (text.split(/\r?\n/).find(l => l.trim().length) || '');
    const delimiter = detectDelimiter(firstLine) || ',';
    const rows = parseCSV(text, delimiter);
    const rendered = render(rows);

    lastState = {
      file,
      rows,
      header: (rendered && rendered.header) || (rows[0] || []),
      delimiter
    };
    window.dispatchEvent(new CustomEvent('csv:preview', { detail: lastState }));
  }

  showPlaceholder();
  return { fromFile, getState: () => lastState };
})();
</script>